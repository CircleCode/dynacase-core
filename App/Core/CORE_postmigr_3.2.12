#!/bin/bash

if [ -z "$wpub" ]; then
    echo "Undefined or empty wpub environment variable!"
    exit 1
fi

if [ -z "$pgservice_core" ]; then
    echo "Undefined or empty pgservice_core!"
    exit 1
fi

_IFS=$IFS
IFS=$'\n'

HTACCESS_LIST=($(PGSERVICE="$pgservice_core" psql -tA -c "SELECT r_path || '/.htaccess' FROM vaultdiskfsstorage"))

for HTACCESS in ${HTACCESS_LIST[*]}; do
    if [ -z "$HTACCESS" ]; then
        continue;
    fi
    if [ -e "$HTACCESS" ]; then
        continue;
    fi
    cat <<'EOF' > "$HTACCESS"
Order Allow,Deny
Deny from all
EOF
done

IFS=$_IFS


PGSERVICE="$pgservice_core" psql --set ON_ERROR_STOP=on -f - << 'SQL'
    CREATE OR REPLACE FUNCTION pg_temp.deleteAllViews(IN _schema TEXT)
    RETURNS void
    LANGUAGE plpgsql
    AS
    $$
    DECLARE
        row     record;
    BEGIN
        FOR row IN
            SELECT
                table_schema,
                table_name
            FROM
                information_schema.views
            WHERE
                table_schema = _schema
        LOOP
            EXECUTE 'DROP VIEW ' || quote_ident(row.table_schema) || '.' || quote_ident(row.table_name);
            RAISE INFO 'Dropped View: %', quote_ident(row.table_schema) || '.' || quote_ident(row.table_name);
        END LOOP;
    END;
    $$;

    SELECT pg_temp.deleteAllViews('family');
    ALTER TABLE doc ALTER COLUMN classname type text;
    ALTER TABLE doc ALTER COLUMN state type text;
    ALTER TABLE doc ALTER COLUMN icon type text;
    ALTER TABLE docread ALTER COLUMN classname type text;
    ALTER TABLE docread ALTER COLUMN state type text;
    ALTER TABLE docread ALTER COLUMN icon type text;
SQL

RET=$?
if [ $RET -ne 0 ]; then
    echo "Error update classname'."
    exit $RET
fi

$wpub/wsh.php --api=generateDocumentClass
RET=$?
if [ $RET -ne 0 ]; then
    echo "Error regenerate views."
    exit $RET
fi