#!/bin/bash

if [ -z "$pgservice_core" ]; then
	echo "Undefined or empty pgservice_core!"
	exit 1
fi

"$wpub/wsh.php" --api=updateclass --appc=FDL --class=docpermext
RET=$?
if [ $RET -ne 0 ]; then
    echo "Error updating class docpermext."
    exit $RET
fi

PGSERVICE="$pgservice_core" psql --set ON_ERROR_STOP=on -f - <<EOF
BEGIN;
DROP SCHEMA family CASCADE;
ALTER TABLE doc ALTER COLUMN usefor TYPE text;
CREATE SCHEMA family;
ALTER TABLE docread ALTER COLUMN usefor TYPE text;
COMMIT;
EOF
RET=$?
if [ $RET -ne 0 ]; then
    echo "Error upgrading 'usefor' columns to type 'text'."
    exit $RET
fi


echo "change old attribute syntax type enumlist, textlist"
PGSERVICE="$pgservice_core" psql -t -c "update docattr set type= 'enum' where type='enumlist' and docid < 200;"
PGSERVICE="$pgservice_core" psql -t -c "update docattr set type= 'text' where type='textlist' and docid < 200;"


PGSERVICE="$pgservice_core" psql -t -c "update users set accounttype='U' where isgroup is null or isgroup != 'Y';"
PGSERVICE="$pgservice_core" psql -t -c "update users set accounttype='G' where isgroup = 'Y';"
PGSERVICE="$pgservice_core" psql -t -c "update doc128 set us_passwd=null;"
PGSERVICE="$pgservice_core" psql -t -c "drop TRIGGER tinitacl on docperm;"
PGSERVICE="$pgservice_core" psql -f "$wpub/FDL/fdl.sql"



#
# Delete deprecated default values
#
PGSERVICE="$pgservice_core" psql -t -c "delete from docattr where id= 'us_iddomain';"
PGSERVICE="$pgservice_core" psql -t -c "delete from docattr where id= 'us_domain';"
PGSERVICE="$pgservice_core" psql -t -c "delete from docattr where id= 'us_passwd';"
PGSERVICE="$pgservice_core" psql -t -c "UPDATE docfam set defval=replace(defval, '[us_iddomain|0]', '') where defval ~ 'us_iddomain';"
PGSERVICE="$pgservice_core" psql -t -c "UPDATE docfam set defval=replace(defval, '[us_iddomain|1]', '') where defval ~ 'us_iddomain';"
PGSERVICE="$pgservice_core" psql -t -c "UPDATE docfam set defval=replace(defval, '[us_domain|local]', '') where defval ~ 'us_domain';"
PGSERVICE="$pgservice_core" psql -t -c "UPDATE docfam set defval=replace(defval, '[us_domain|externe]', '') where defval ~ 'us_domain';"


